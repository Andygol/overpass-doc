Загальне
========

Публічно доступні екзепляри чекають на ваші запити.
Вони пропонуть достатню кількість ресурсів, що є у них в наявності,
але вони захищені від надмірного навантаження.
Користувачі, що потребують значних обчислень, можуть розгрнути власний екземпляр API.

<a name="magnitudes"/>
## Навантаження

Місією публічних екземплярів бути доступними для великої кількості користувачів.
На поточний момент обчислювальні потужності розподіляються серед 30 тис. користувачів щодня.

Типовий запит виконується менше ніж за 1 секунду,
але є запити, які виконуються значно довше.
Кожен з серверів Overpass API може задовольнити близько 1 мільйона запитів на день,
і два сервери знаходяться за адресою [overpass-api.de](https://wiki.openstreetmap.org/wiki/Overpass_API#Public_Overpass_API_instances).

Надзвичайно малоймовірно, що ви коли-небудь будете створювати проблеми з запитами поданими вручну.
На жаль, ви все ще можете зіткнутися із захистом від навантажень - алгоритм квот не ідеальний.

Приклади проблемної поведінки:

1. Десятки тисяч разів на день надсилання одного і того ж запиту (з однієї адреси)
2. Надсилання запитів про окремі елементи OSM один за одним мільйони разів.
3. Робити запит для всього світу з метою отримати всі дані.
4. Створення застосунків не лише для маперів,
   використовуючи публічні сервери у якості бекенду вашого комерційного сервісу.

В першому випадку вам потрібно виправити ваш запит.
У випадках 2 та 3 краще звернутись за даними до [дампу планети](https://wiki.openstreetmap.org/wiki/Planet.osm) ніж до Overpass API.
В останньому випадку, лише розгортання власного екземпляра дозволить вам надавати ваші послуги безперебійно.
Розгортання власного екземпляра є темою [окремого розділу](../more_info/setup.md).

Насправді більшість користувачів надсилають лише кілька запитів.
Автоматичні процедури керування навантаженням на сервер
надають найвищий пріоритет кільком першим запитам користувачів перед запитами, що надсилаються іншими.
Ручне керування також може мати місце для тих, хто надмірно навантажує сервери запитами
і наступні припущення про максимальні навантаження дають певний простір у підтримані роботи серверів.

Ручне керування може бути запроваджене для користувачів кількість запитів яких
наближається до 10000 на день або обсяг даних для завантаження наближається до 1 Гб.

Серед цілей декларованих проєктом Overpass API - спрощення запуску вашого власного екземпляра Overpass API.
Якщо очікувані потреби перевищують описані виші вимоги,
зважте на [розгортання власного екземпляра Overpass API](../more_info/setup.md).

Якщо вас цікавлять правила автоматичного регулювання навантаження
тоді, будь ласка, прочитайте наступний розділ.

<a name="quotas"/>
## Квоти

Процеси автоматичного регулювання навантаження (анонімізовано) відстежують
коли та які запити користувач надсилає
та оцінюють, чи користувачі які створюють помірне навантаження все ще мають доступ до сервера,
якщо загальна кількість запитів наближається до пікових можливостей сервера.

Зараз працюють два незалежних публічних екземпляри,
[z.overpass-api.de](https://z.overpass-api.de/api/status) та [lz4.overpass-api.de](https://lz4.overpass-api.de/api/status).
Розпочнемо пояснення квот з допомогою відстеження станів запитів.

### Обмеження запитів

Запит, зазвичай асоціюється з користувачем за IP адресою.
Якщо ідентифікатор користувача міститься в запиті, використовується він замісць IP.
Для адрес IPv4 оцінюється повна адреса.
Для адрес IPv6 - тільки перші 64 біти адреси.
Оскільки досі не зрозуміло, які блоки адреси будуть звичайними
кілька додаткових блоків адреси можуть бути додані згодом.
Ідентифікатор користувача визначається сервером і завжди показується в [запиті стану](https://overpass-api.de/api/status) в рядку ``Connected as:``.

Виконання кожного запиту вимагає одного виділеного слоту для користувача,
повний фактичний час виконання також включає час "охолодження".
Час на "холодження" потрібен, щоб
дати можливість іншим користувачам надіслати власні запити.
Час на "охолодження" зростає одночасно з ростом навантаження на сервер і є пропорційним часу виконання запиту.
За невеликого навантаження на сервер час охолодження може бути лише часткою від часу виконання.
З ростом навантаження час охолодження стає в кілька разів довшим за час виконання запиту.

Рух мапи призводить до створення досить коротких запитів в продовж невеликого проміжку часу.
Для того, щоб бути впевненими що всі запити користувачів будуть виконані
застосовуються наступні механізми:

* Кожен користувач отримує кілька слотів.
  Кількість доступних слотів зазначається в рядку після ``Rate limit:``.
* Запити залишаються в черзі впродовж 15 секунд,
  якщо у вас немає вільних слотів для їх виконання.

Наприклад: якщо рух мапи створює 20 запитів на виконання яких вимагається 1 секунда серверного часу,
а доступних слотів 2 та ліміт на виконання запитів та час на "охолодження" - 1 до 1, тоді

* перші два запити виконуються миттєво
* наступні два запити отримуються
  та виконуються із затримкою у 2 секунди (1 сек - час виконання, 1 сек - час охолодження)
* наступні запити виконуються з відповідною затримкою
* запити 15 та 16 будуть виконані після 14 сек затримки
* запити з 17 по 20 будуть відкинуть після 15 сек очікування
  через відсутність зарезервованих раніше слотів для їх виконання.

Якщо клієнт все ще потребує результатів запитів 17-20
(та не переміщав мапу в інше місце)
тоді платформа клієнта має наново направити ці запити через 15 секунд.
Ознайомтесь з розділом [про OpenLayers and Leaflet](../targets/index.md), щоб дізнатись як це зробити.

Причиною впровадження такого захисту є скрипти в нескінченому циклі,
багато з них надсилають кілька запитів паралельно, які відкладаються цим механізмом,
через затримку виконання, вони отримують повідомлення про відмову з відповідною затримкою.

Якщо запит виконується впродовж значного часу, займаючи відповідний слот для цього,
інформація про це буде зазначено в рядку 6 звіту,
також буде зазначено, як швидко ви зможете скористатись цим слотом знову.

Запити, які відхилені через перевищення доступних слотів отримують відповідь сервера - [HTTP status code 429](https://tools.ietf.org/html/rfc6585#section-4).

### Timeout та Maxsize

Незалежно від  виділених слотів існує й інший механізм.
Він надає перевагу виконанню невеличких запитів перед великими, масивними запитами,
щоб надати можливість користувачам з невеликими запитами отримати відповіді на них,
навіть коли великі запити майже вичерпали всі можливості сервера.

Для цього використовуються критерії по часу виконання запиту та максимально використаного обсягу оперативної пам'яті сервера.
Кожен запит містить оголошення про очікуваний максимальний час виконання та використання пам'яті.
Оголошення про очікуваний максимальний час виконання може зазначатись явним чином з використанням ``[timeout:...]`` на початку тексту запиту;
оголошення про максимальний обсяг використання пам'яті також можна зробити явним чином, додавши на початку тексту запиту ``[maxsize:...]``.
Ці оголошення можна використовувати разом.

Якщо не оголошено максимальний час виконання запиту, застосовується типове обмеження у 180 секунд.
Типове обмеження максимального обсягу пам'яті складає 512 MiB.

Якщо час виконання запиту перевищує максимальний час або обсяги виділеної пам'яті,
сервер припиняє його обробку.
Виконання цього [запиту](https://overpass-turbo.eu/?lat=51.4775&lon=0.0&zoom=10&Q=%5Btimeout%3A3%5D%3B%0Anwr%5Bshop%3Dsupermarket%5D%28%7B%7Bbbox%7D%7D%29%3B%0Aout%20center%3B) завершиться після 3 секунд його обробки:

    [timeout:3];
    nwr[shop=supermarket]({{bbox}});
    out center;

[Той самий запит, але з більшим часом на виконання](https://overpass-turbo.eu/?lat=51.4775&lon=0.0&zoom=10&Q=%5Btimeout%3A90%5D%3B%0Anwr%5Bshop%3Dsupermarket%5D%28%7B%7Bbbox%7D%7D%29%3B%0Aout%20center%3B) відпрацьовує як треба:

    [timeout:90];
    nwr[shop=supermarket]({{bbox}});
    out center;

Повернемося до квот:
Сервер приймає запит тоді і тільки тоді, коли
він може застосувати обидва критерії і вони не будуть
перевищувати половину вільних ресурсів сервера.
Для максимального прийнятного обсягу пам'яті наразі значення становить 12 ГіБ.
Якщо в момент надсилання запиту виконуються інші 8 запитів, кожен з яких потребує 512 МіБ,
на сервері під їх виконання резервується 4 ГіБ оперативної пам'яті.
Наступні запити будуть прийняті до виконання якщо вони обіцяють використовувати 
не більше ніж 4 ГіБ (половину від наявного залишку пам'яті 12 - 4 = 8 ГіБ).
Виконуючи дев'ять запитів одночасно сервер матиме доступними 4 ГіБ
та наступний запит із потребами в використанні пам'яті меншими за 2 ГіБ будуть прийняті в роботу.

З зазначенням максимального часу роботи запиту система поводиться відповідно:
на поточний момент середній ліміт складає 262144 секунд.
Це означає, що майже завжди буде прийнято в роботу один запит із максимальним часом виконання до 1 дня,
але тоді кожен наступний запит з таким тривалим часом виконання буде відхилено.
Механізм обмеження навантаження з відповідно великим часом охолодження гарантує,
що не завжди один і той же користувач може отримати зиск від надзвичайно тривалих запитів.

Як і з обмеженням швидкості, сервер не відразу відхиляє запити,
але чекає 15 секунд
чого має вистачити на виконання інших запитів.

Ви можете подивитись статистику навантаження на сервери 
[тут](https://z.overpass-api.de/munin/localdomain/localhost.localdomain/index.html#other) та [тут](https://lz4.overpass-api.de/munin/localdomain/localhost.localdomain/index.html#other).

На запити, відхилені з допомогою механізму обмеження навантаження, надходять відповіді з [HTTP status code 504](https://tools.ietf.org/html/rfc7231#section-6.6.5).
